---
tags:
  - study
  - spring
  - data
  - transaction
created: 2025-02-08
---

# íŠ¸ëœì­ì…˜ ê´€ë¦¬

## í•œ ì¤„ ìš”ì•½
> Springì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ” @Transactional ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ì„ ì œê³µí•˜ì—¬, ë°ì´í„° ì¼ê´€ì„±ê³¼ ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ë©´ì„œë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ ë¶„ë¦¬í•œë‹¤.

## ìƒì„¸ ì„¤ëª…

### íŠ¸ëœì­ì…˜ì´ë€?
- **ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì˜ ë…¼ë¦¬ì  ë‹¨ìœ„**
- All or Nothing: ëª¨ë‘ ì„±ê³µ ë˜ëŠ” ëª¨ë‘ ì‹¤íŒ¨
- ACID ì†ì„± ë³´ì¥

### ACID ì†ì„±

| ì†ì„± | ì„¤ëª… |
|------|------|
| **Atomicity (ì›ìì„±)** | íŠ¸ëœì­ì…˜ì˜ ëª¨ë“  ì—°ì‚°ì´ ì„±ê³µí•˜ê±°ë‚˜ ëª¨ë‘ ì‹¤íŒ¨ |
| **Consistency (ì¼ê´€ì„±)** | íŠ¸ëœì­ì…˜ ì „í›„ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì¼ê´€ì„± ìœ ì§€ |
| **Isolation (ê²©ë¦¬ì„±)** | ë™ì‹œ ì‹¤í–‰ íŠ¸ëœì­ì…˜ì´ ì„œë¡œ ê°„ì„­í•˜ì§€ ì•ŠìŒ |
| **Durability (ì§€ì†ì„±)** | ì»¤ë°‹ëœ íŠ¸ëœì­ì…˜ì€ ì˜êµ¬ì ìœ¼ë¡œ ë°˜ì˜ |

### ì™œ íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œê°€?
```java
// âŒ íŠ¸ëœì­ì…˜ ì—†ì´ ê³„ì¢Œ ì´ì²´
public void transfer(Long fromId, Long toId, int amount) {
    Account from = accountRepository.findById(fromId);
    Account to = accountRepository.findById(toId);
    
    from.withdraw(amount);  // ì¶œê¸ˆ ì„±ê³µ
    accountRepository.save(from);
    
    // ğŸ’¥ ì—¬ê¸°ì„œ ì˜ˆì™¸ ë°œìƒ!
    to.deposit(amount);  // ì…ê¸ˆ ì‹¤íŒ¨
    accountRepository.save(to);
}
```
â†’ ì¶œê¸ˆì€ ëëŠ”ë° ì…ê¸ˆì´ ì•ˆ ë¨! ëˆì´ ì‚¬ë¼ì§! ğŸ˜±

### Spring íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë°©ë²•

#### 1. ì„ ì–¸ì  íŠ¸ëœì­ì…˜ (ê¶Œì¥)
- **@Transactional ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©**
- AOP ê¸°ë°˜ìœ¼ë¡œ í”„ë¡ì‹œ ìƒì„±
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¶„ë¦¬

#### 2. í”„ë¡œê·¸ë˜ë° ë°©ì‹ íŠ¸ëœì­ì…˜
- **TransactionTemplate ì‚¬ìš©**
- íŠ¸ëœì­ì…˜ ì½”ë“œê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì„ì„
- ì„¸ë°€í•œ ì œì–´ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©

### @Transactional ë™ì‘ ì›ë¦¬
```
1. í”„ë¡ì‹œ ê°ì²´ ìƒì„± (AOP)
   â†“
2. ë©”ì„œë“œ í˜¸ì¶œ â†’ í”„ë¡ì‹œê°€ ê°€ë¡œì±”
   â†“
3. íŠ¸ëœì­ì…˜ ì‹œì‘ (TransactionManager)
   â†“
4. ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
   â†“
5. ì •ìƒ ì¢…ë£Œ â†’ ì»¤ë°‹
   ì˜ˆì™¸ ë°œìƒ â†’ ë¡¤ë°±
   â†“
6. íŠ¸ëœì­ì…˜ ì¢…ë£Œ
```

### @Transactional ì†ì„±

| ì†ì„± | ì„¤ëª… | ê¸°ë³¸ê°’ |
|------|------|--------|
| **propagation** | íŠ¸ëœì­ì…˜ ì „íŒŒ ë°©ì‹ | REQUIRED |
| **isolation** | íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ | DEFAULT |
| **timeout** | íƒ€ì„ì•„ì›ƒ (ì´ˆ) | -1 (ë¬´ì œí•œ) |
| **readOnly** | ì½ê¸° ì „ìš© ì—¬ë¶€ | false |
| **rollbackFor** | ë¡¤ë°±í•  ì˜ˆì™¸ í´ë˜ìŠ¤ | RuntimeException |
| **noRollbackFor** | ë¡¤ë°±í•˜ì§€ ì•Šì„ ì˜ˆì™¸ | - |

### íŠ¸ëœì­ì…˜ ì „íŒŒ (Propagation)
- [[íŠ¸ëœì­ì…˜-ì „íŒŒ]] ì°¸ê³ 

### íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ (Isolation)
- [[íŠ¸ëœì­ì…˜-ê²©ë¦¬ìˆ˜ì¤€]] ì°¸ê³ 

## ì½”ë“œ ì˜ˆì‹œ

```java
// 1. ê¸°ë³¸ @Transactional
@Service
@RequiredArgsConstructor
public class AccountService {
    
    private final AccountRepository accountRepository;
    
    @Transactional
    public void transfer(Long fromId, Long toId, int amount) {
        Account from = accountRepository.findById(fromId)
                .orElseThrow(AccountNotFoundException::new);
        Account to = accountRepository.findById(toId)
                .orElseThrow(AccountNotFoundException::new);
        
        from.withdraw(amount);
        to.deposit(amount);
        
        // ì˜ˆì™¸ ë°œìƒ ì‹œ ìë™ ë¡¤ë°±
        if (amount > 10000) {
            throw new IllegalArgumentException("ìµœëŒ€ ì´ì²´ ê¸ˆì•¡ ì´ˆê³¼");
        }
        
        // ì •ìƒ ì¢…ë£Œ ì‹œ ìë™ ì»¤ë°‹
    }
}

// 2. ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ (ì„±ëŠ¥ ìµœì í™”)
@Transactional(readOnly = true)
public List<Account> findAll() {
    // ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜:
    // - Dirty Checking ë¹„í™œì„±í™”
    // - í”ŒëŸ¬ì‹œ ëª¨ë“œë¥¼ MANUALë¡œ ì„¤ì •
    // - DBì— ë”°ë¼ ì½ê¸° ìµœì í™” (replication slave ì‚¬ìš© ë“±)
    return accountRepository.findAll();
}

// 3. íŠ¹ì • ì˜ˆì™¸ë§Œ ë¡¤ë°±
@Transactional(rollbackFor = Exception.class)  // Checked Exceptionë„ ë¡¤ë°±
public void createAccount(Account account) throws Exception {
    accountRepository.save(account);
    
    if (account.getBalance() < 0) {
        throw new Exception("ì”ì•¡ì´ ìŒìˆ˜ì…ë‹ˆë‹¤");  // ë¡¤ë°±ë¨
    }
}

// 4. íŠ¹ì • ì˜ˆì™¸ëŠ” ë¡¤ë°±í•˜ì§€ ì•ŠìŒ
@Transactional(noRollbackFor = CustomException.class)
public void processAccount(Account account) {
    accountRepository.save(account);
    
    if (someCondition) {
        throw new CustomException();  // ë¡¤ë°± ì•ˆ ë¨, ì»¤ë°‹ë¨
    }
}

// 5. íƒ€ì„ì•„ì›ƒ ì„¤ì •
@Transactional(timeout = 5)  // 5ì´ˆ ì œí•œ
public void longRunningProcess() {
    // 5ì´ˆ ë„˜ìœ¼ë©´ TransactionTimedOutException ë°œìƒ
    accountRepository.findAll();
}

// 6. í´ë˜ìŠ¤ ë ˆë²¨ @Transactional
@Service
@Transactional  // ëª¨ë“  public ë©”ì„œë“œì— ì ìš©
@RequiredArgsConstructor
public class OrderService {
    
    @Transactional(readOnly = true)  // ë©”ì„œë“œ ë ˆë²¨ì´ ìš°ì„ 
    public Order findById(Long id) {
        return orderRepository.findById(id)
                .orElseThrow(OrderNotFoundException::new);
    }
    
    public void createOrder(Order order) {
        // í´ë˜ìŠ¤ ë ˆë²¨ @Transactional ì ìš©
        orderRepository.save(order);
    }
}

// 7. í”„ë¡œê·¸ë˜ë° ë°©ì‹ íŠ¸ëœì­ì…˜
@Service
@RequiredArgsConstructor
public class PaymentService {
    
    private final TransactionTemplate transactionTemplate;
    private final PaymentRepository paymentRepository;
    
    public void processPayment(Payment payment) {
        transactionTemplate.execute(status -> {
            try {
                paymentRepository.save(payment);
                
                if (payment.getAmount() < 0) {
                    status.setRollbackOnly();  // ìˆ˜ë™ ë¡¤ë°±
                }
                
                return payment;
            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
        });
    }
}

// 8. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì§ì ‘ ì‚¬ìš©
@Service
@RequiredArgsConstructor
public class ManualTransactionService {
    
    private final PlatformTransactionManager transactionManager;
    
    public void executeWithManualTransaction() {
        TransactionDefinition def = new DefaultTransactionDefinition();
        TransactionStatus status = transactionManager.getTransaction(def);
        
        try {
            // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            
            transactionManager.commit(status);
        } catch (Exception e) {
            transactionManager.rollback(status);
            throw e;
        }
    }
}

// 9. ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì‚¬ìš©
@Configuration
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager primaryTransactionManager(
            EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
    
    @Bean
    public PlatformTransactionManager secondaryTransactionManager(
            @Qualifier("secondaryEntityManagerFactory") EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
}

@Service
public class MultiDBService {
    
    @Transactional("primaryTransactionManager")
    public void saveToPrimary(User user) {
        // Primary DBì— ì €ì¥
    }
    
    @Transactional("secondaryTransactionManager")
    public void saveToSecondary(Log log) {
        // Secondary DBì— ì €ì¥
    }
}

// 10. íŠ¸ëœì­ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
@Component
public class OrderEventListener {
    
    // íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „
    @TransactionalEventListener(phase = TransactionPhase.BEFORE_COMMIT)
    public void beforeCommit(OrderCreatedEvent event) {
        // ì»¤ë°‹ ì§ì „ì— ì‹¤í–‰
    }
    
    // íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void afterCommit(OrderCreatedEvent event) {
        // ì»¤ë°‹ ì™„ë£Œ í›„ ì‹¤í–‰ (ì™¸ë¶€ API í˜¸ì¶œ ë“±)
    }
    
    // íŠ¸ëœì­ì…˜ ë¡¤ë°± í›„
    @TransactionalEventListener(phase = TransactionPhase.AFTER_ROLLBACK)
    public void afterRollback(OrderCreatedEvent event) {
        // ë¡¤ë°± í›„ ë³´ìƒ ì²˜ë¦¬
    }
    
    // íŠ¸ëœì­ì…˜ ì™„ë£Œ í›„ (ì»¤ë°‹/ë¡¤ë°± ìƒê´€ì—†ì´)
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMPLETION)
    public void afterCompletion(OrderCreatedEvent event) {
        // í•­ìƒ ì‹¤í–‰
    }
}

// 11. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì½œë°±
@Service
public class PaymentService {
    
    @Transactional
    public void processPayment(Payment payment) {
        paymentRepository.save(payment);
        
        // íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ì‹¤í–‰í•  ì‘ì—… ë“±ë¡
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    // ì»¤ë°‹ í›„ ì™¸ë¶€ ê²°ì œ API í˜¸ì¶œ
                    externalPaymentApi.notify(payment);
                }
            }
        );
    }
}
```

## ì£¼ì˜ì‚¬í•­ / í•¨ì •

### 1. í”„ë¡ì‹œ ë°©ì‹ì˜ í•œê³„
```java
@Service
public class UserService {
    
    public void outerMethod() {
        this.innerMethod();  // âŒ íŠ¸ëœì­ì…˜ ì ìš© ì•ˆ ë¨!
    }
    
    @Transactional
    public void innerMethod() {
        // í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•Šì•„ íŠ¸ëœì­ì…˜ ì‹œì‘ ì•ˆ ë¨
    }
}

// âœ… í•´ê²° ë°©ë²•
@Service
@RequiredArgsConstructor
public class UserService {
    
    private final InternalService internalService;
    
    public void outerMethod() {
        internalService.innerMethod();  // ë‹¤ë¥¸ ë¹ˆ í˜¸ì¶œ
    }
}
```

### 2. Checked Exception ë¡¤ë°± ì•ˆ ë¨
```java
@Transactional
public void method() throws Exception {
    userRepository.save(user);
    throw new Exception();  // âŒ ë¡¤ë°± ì•ˆ ë¨! (Checked Exception)
}

// âœ… í•´ê²° ë°©ë²•
@Transactional(rollbackFor = Exception.class)
public void method() throws Exception {
    userRepository.save(user);
    throw new Exception();  // ë¡¤ë°±ë¨
}
```

### 3. readOnly ì†ì„± ì˜¤í•´
```java
@Transactional(readOnly = true)
public void updateUser(User user) {
    userRepository.save(user);  // âŒ readOnlyì¸ë° ì“°ê¸° ì‘ì—…!
    // DBì— ë”°ë¼ ì—ëŸ¬ ë°œìƒí•˜ê±°ë‚˜ ë¬´ì‹œë¨
}

// âœ… ì½ê¸°ë§Œ í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©
@Transactional(readOnly = true)
public User findById(Long id) {
    return userRepository.findById(id)
            .orElseThrow(UserNotFoundException::new);
}
```

### 4. íŠ¸ëœì­ì…˜ ë²”ìœ„ ë„ˆë¬´ í¼
```java
// âŒ ì™¸ë¶€ API í˜¸ì¶œê¹Œì§€ íŠ¸ëœì­ì…˜ì— í¬í•¨
@Transactional
public void processOrder(Order order) {
    orderRepository.save(order);
    
    // DB ì»¤ë„¥ì…˜ì„ ì˜¤ë˜ ì ìœ 
    externalApi.notifyOrder(order);  // 5ì´ˆ ì†Œìš”
}

// âœ… íŠ¸ëœì­ì…˜ ë¶„ë¦¬
@Transactional
public void saveOrder(Order order) {
    orderRepository.save(order);
}

public void processOrder(Order order) {
    saveOrder(order);
    externalApi.notifyOrder(order);  // íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì‹¤í–‰
}
```

### 5. ì˜ˆì™¸ ì²˜ë¦¬ í›„ ì¬ë˜ì§€ê¸°
```java
@Transactional
public void method() {
    try {
        userRepository.save(user);
    } catch (Exception e) {
        log.error("ì—ëŸ¬", e);
        // âŒ ì˜ˆì™¸ë¥¼ ë¨¹ì–´ë²„ë¦¼ â†’ ì»¤ë°‹ë¨!
    }
}

// âœ… ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì•¼ ë¡¤ë°±
@Transactional
public void method() {
    try {
        userRepository.save(user);
    } catch (Exception e) {
        log.error("ì—ëŸ¬", e);
        throw e;  // ë‹¤ì‹œ ë˜ì§€ê¸°
    }
}
```

### 6. ë¹„ë™ê¸° ë©”ì„œë“œì— @Transactional
```java
@Transactional
@Async  // âŒ íŠ¸ëœì­ì…˜ì´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¡œ ì „íŒŒ ì•ˆ ë¨!
public void asyncMethod() {
    userRepository.save(user);
}

// âœ… ë¹„ë™ê¸° ë©”ì„œë“œ ë‚´ë¶€ì—ì„œ íŠ¸ëœì­ì…˜ ì‹œì‘
@Async
public void asyncMethod() {
    transactionalService.saveUser(user);  // ì—¬ê¸°ì„œ @Transactional
}
```

### 7. private ë©”ì„œë“œì— @Transactional
```java
// âŒ private ë©”ì„œë“œëŠ” í”„ë¡ì‹œ ì ìš© ì•ˆ ë¨
@Transactional
private void saveUser(User user) {
    userRepository.save(user);
}

// âœ… public ë©”ì„œë“œë§Œ ê°€ëŠ¥
@Transactional
public void saveUser(User user) {
    userRepository.save(user);
}
```

## ê´€ë ¨ ê°œë…
- [[íŠ¸ëœì­ì…˜-ì „íŒŒ]]
- [[íŠ¸ëœì­ì…˜-ê²©ë¦¬ìˆ˜ì¤€]]
- [[Spring-Data-JPA-ì—°ë™]]
- [[AOP-ê°œë…ê³¼-í™œìš©]]

## ë©´ì ‘ ì§ˆë¬¸

1. **íŠ¸ëœì­ì…˜ì˜ ACID ì†ì„±ì„ ì„¤ëª…í•˜ì„¸ìš”.**
   - Atomicity: All or Nothing
   - Consistency: ì¼ê´€ì„± ìœ ì§€
   - Isolation: ê²©ë¦¬ì„±
   - Durability: ì§€ì†ì„±

2. **@Transactionalì˜ ë™ì‘ ì›ë¦¬ëŠ”?**
   - AOP ê¸°ë°˜ í”„ë¡ì‹œ ìƒì„±
   - ë©”ì„œë“œ ì‹¤í–‰ ì „ íŠ¸ëœì­ì…˜ ì‹œì‘
   - ì •ìƒ ì¢…ë£Œ â†’ ì»¤ë°‹, ì˜ˆì™¸ ë°œìƒ â†’ ë¡¤ë°±

3. **Checked Exceptionê³¼ Unchecked Exceptionì˜ ë¡¤ë°± ì°¨ì´ëŠ”?**
   - Unchecked(RuntimeException): ê¸°ë³¸ ë¡¤ë°±
   - Checked(Exception): ê¸°ë³¸ ë¡¤ë°± ì•ˆ ë¨ (rollbackFor í•„ìš”)

4. **readOnly=trueì˜ ì¥ì ì€?**
   - Dirty Checking ë¹„í™œì„±í™” â†’ ì„±ëŠ¥ í–¥ìƒ
   - í”ŒëŸ¬ì‹œ ëª¨ë“œ MANUAL
   - DB ì½ê¸° ìµœì í™” (replication slave í™œìš© ë“±)

5. **ê°™ì€ í´ë˜ìŠ¤ ë‚´ë¶€ ë©”ì„œë“œ í˜¸ì¶œ ì‹œ @Transactionalì´ ì ìš© ì•ˆ ë˜ëŠ” ì´ìœ ëŠ”?**
   - í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì§ì ‘ í˜¸ì¶œë˜ê¸° ë•Œë¬¸
   - thisë¡œ í˜¸ì¶œí•˜ë©´ í”„ë¡ì‹œê°€ ì•„ë‹Œ ì‹¤ì œ ê°ì²´ í˜¸ì¶œ

6. **íŠ¸ëœì­ì…˜ ì „íŒŒ ë°©ì‹ì˜ ê¸°ë³¸ê°’ì€?**
   - REQUIRED (ê¸°ì¡´ íŠ¸ëœì­ì…˜ ìˆìœ¼ë©´ ì°¸ì—¬, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±)

7. **ì—¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•  ë•Œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ”?**
   - ê° DBë³„ë¡œ TransactionManager ë¹ˆ ìƒì„±
   - @Transactionalì— transactionManager ì†ì„±ìœ¼ë¡œ ì§€ì •

## ì°¸ê³  ìë£Œ
- ê¹€ì˜í•œì˜ ìŠ¤í”„ë§ DB 1í¸ - ë°ì´í„° ì ‘ê·¼ í•µì‹¬ ì›ë¦¬
- Spring Framework Reference - Transaction Management
- https://docs.spring.io/spring-framework/reference/data-access/transaction.html
