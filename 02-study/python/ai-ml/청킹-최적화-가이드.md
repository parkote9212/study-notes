---
tags:
  - study
created: 2026-01-23
difficulty: 중
---
# 청킹 최적화 가이드 (법령 문서 중심)

## **📋 변경 사항 요약**

### **1️⃣ 청킹 사이즈 조정 (`app/core/config.py`)**

| **파라미터** | **이전** | **현재** | **목적** |
| --- | --- | --- | --- |
| `CHUNK_SIZE` | 600 | 1500 | 법령 조항(800~1200자) 온전히 포함 |
| `CHUNK_OVERLAP` | 100 | 150 | 조항 경계에서 문맥 손실 방지 |
| `TABLE_CHUNK_SIZE` | 800 | 1200 | 표 블록도 함께 커질 수 있게 조정 |

**이유:**

- 기존 600자는 법령 한 조항(예: 제123조 1항)을 완전히 포함하지 못함
- 1500자 크기로 조항 경계를 명확히 유지 가능
- 150자 오버랩으로 인접 조항 간 문맥 연결

### **2️⃣ 구분자 우선순위 재조정 (`app/core/utils.py`)**

새로운 구분자 순서 (정규식):

```python
separators = [
    r"\n제\s*\d+",  # 1순위: "제 123조" 조항 분리
    r"\n\d+\.\s",   # 2순위: "1. " 번호 매김 분리
    "\n\n",         # 3순위: 문단(기존)
    ".\n",          # 4순위: 문장 끝(기존)
    "\n",           # 5순위: 줄바꿈(기존)
    ". ",           # 6순위: 문장(기존)
    " ",            # 7순위: 공백(기존)
    ""              # 8순위: 글자(최후 수단)
]
```

**작동 원리:**

1. 먼저 `제 123조` 패턴으로 조항 단위로 분리 시도
2. 조각이 1500자 초과면 다음 구분자(1.)로 재시도
3. 그래도 크면 문단/문장으로 세분화
4. 마지막에는 글자 단위로 강제 분할

### **3️⃣ 로깅 추가 (업로드 엔드포인트)**

```
--- 파일명: labor_law.pdf ---
추출된 텍스트 길이: 45230자
추출 내용 앞부분: 산업안전보건법 [시행 2023.1.1.] ...
청킹 결과: 28개 조각 생성 (크기: 1500, 오버랩: 150)
```

---

## **🎯 법령 문서 최적화 효과**

### **Before (600/100)**

```
제1조 목적
이 법은 산업안전보건상의 위험을 예방하고 쾌적한
[여기서 청크 끝남] ❌ 조항이 분산됨
근로환경을 유지함으로써 ...
```

### **After (1500/150)**

```
제1조 목적
이 법은 산업안전보건상의 위험을 예방하고 쾌적한
근로환경을 유지함으로써 근로자의 안전, 보건 및
복지증진에 기여함을 목적으로 한다.

제2조 정의
① "사업"이란 ...
② "사업장"이란 ...
③ "근로자"란 ...
[논리적 완성도 높은 조각] ✅
```

---

## **📊 권장 설정값 비교**

### **법령/정책 문서 (현재)**

- Size: **1500** (조항 중심)
- Overlap: **150** (문맥 보존)

### **일반 기술 문서 (참고)**

- Size: 1000
- Overlap: 100

### **요약 자료/FAQ (참고)**

- Size: 500
- Overlap: 50

---

## **🔧 커스터마이징**

특정 문서 유형별로 조정하려면:

```python
# app/api/admin.py에서
chunks = table_aware_chunk_text(
    full_text,
    size=2000,      # 더 큰 조항용
    overlap=200     # 높은 문맥 보존
)
```

또는 `config.py`에서 문서 유형별 상수 추가:

```python
# app/core/config.py에서
CHUNK_CONFIGS = {
    "regulation": {"size": 1500, "overlap": 150},
    "technical": {"size": 1000, "overlap": 100},
    "summary": {"size": 500, "overlap": 50},
}
```

---

## **✅ 검증 방법**

1. 문서 업로드 후 콘솔 로그 확인:
    
    ```bash
    curl -F "file=@labor_law.pdf" http://localhost:8000/admin/upload-knowledge
    ```

2. DB 샘플 조회:
    
    ```bash
    curl "http://localhost:8000/admin/inspect-db?limit=5"
    ```

3. 조항이 제대로 묶여있는지 응답에서 확인

---

## **📝 적용 체크리스트**

- [x]  `CHUNK_SIZE = 1500` 설정
- [x]  `CHUNK_OVERLAP = 150` 설정
- [x]  정규식 기반 조항 구분자 추가
- [x]  업로드 엔드포인트 로깅 강화
- [x]  파일 저장 및 테스트 준비 완료

이제 법령 문서를 업로드하면 조항 단위로 최적화된 청킹이 적용됩니다! 🎉
